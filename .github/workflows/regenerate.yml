name: regenerate
on:
  workflow_dispatch: # allows manual triggering
  pull_request:
    branches:
      - main
jobs:
  regenerate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: cachix/install-nix-action@v21
      with:
        extra_nix_config: |
          accept-flake-config = true
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    - uses: cachix/cachix-action@v12
      with:
        name: klarkc
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: regenerate nix/package-set
      run: |
        set -e
        nix build .#generator --show-trace --impure
        cp result nix/package-set/default.nix
    - name: Check for changes
      id: git-check
      run: |
        if [[ -z "$(git status --porcelain)" ]]; then
          echo "changes=false" >> $GITHUB_ENV
        else
          echo "changes=true" >> $GITHUB_ENV
        fi
    - name: Commit changes
      if: env.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add nix/package-set/default.nix
        git commit -m "build(package-set): regenerate package-set"
    - name: Push changes
      if: env.changes == 'true'
      run: git push origin HEAD:${{ github.head_ref }}
